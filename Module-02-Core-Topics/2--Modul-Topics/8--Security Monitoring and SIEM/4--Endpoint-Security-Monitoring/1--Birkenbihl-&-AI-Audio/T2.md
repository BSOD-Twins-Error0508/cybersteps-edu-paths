Developed by Facebook, osquery is a unique and powerful tool that takes a different approach. Entwickelt von Facebook, ist osquery ein einzigartiges und mächtiges Werkzeug, das einen anderen Ansatz verfolgt.

It treats an operating system as a high performance relational database. Es behandelt ein Betriebssystem als eine hochleistungsfähige relationale Datenbank.

This means you can use standard SQL like queries to explore the current state of an endpoint in real time. Das bedeutet, Sie können standardmäßige SQL-ähnliche Abfragen verwenden, um den aktuellen Zustand eines Endpunkts in Echtzeit zu erkunden.

Instead of just collecting logs of things that happened, past events, osquery lets you ask questions about what is, current state. Anstatt nur Logs von Dingen zu sammeln, die passiert sind, vergangene Ereignisse, lässt osquery Sie Fragen stellen über das, was ist, aktueller Zustand.

You run a small agent on your endpoints and can then ask questions like, SELECT asterisk FROM users WHERE username equals admin. Sie führen einen kleinen Agent auf Ihren Endpunkten aus und können dann Fragen stellen wie, SELECT Sternchen FROM users WHERE username equals admin.

Show me all admin users. Zeig mir alle Admin-Benutzer.

SELECT pid, name, path FROM processes WHERE on underscore disk equals zero. SELECT pid, name, path FROM processes WHERE on Unterstrich disk equals null.

Show me running processes that don't have a corresponding file on the disk, a common sign of fileless malware. Zeig mir laufende Prozesse, die keine entsprechende Datei auf der Festplatte haben, ein häufiges Zeichen für dateilose Malware.

SELECT asterisk FROM listening underscore ports WHERE address equals zero dot zero dot zero dot zero. SELECT Sternchen FROM listening Unterstrich ports WHERE address equals null Punkt null Punkt null Punkt null.

Show me all processes listening for connections from any IP address. Zeig mir alle Prozesse, die auf Verbindungen von jeder IP-Adresse lauschen.

This query based approach is incredibly flexible for threat hunting and incident response, allowing you to proactively search for indicators of compromise across your entire fleet of machines. Dieser abfragebasierte Ansatz ist unglaublich flexibel für Bedrohungsjagd und Vorfallreaktion und ermöglicht es Ihnen, proaktiv nach Kompromittierungsindikatoren über Ihre gesamte Maschinenflotte zu suchen.

Think about it. Denken Sie darüber nach.

Logs from Sysmon or Wazuh tell you what happened in the past. Logs von Sysmon oder Wazuh sagen Ihnen, was in der Vergangenheit passiert ist.

State based querying with osquery tells you what is true right now. Zustandsbasierte Abfragen mit osquery sagen Ihnen, was genau jetzt wahr ist.

In an incident response scenario, why would you need both capabilities? In einem Vorfallreaktionsszenario, warum würden Sie beide Fähigkeiten brauchen?

What kind of questions can you answer with one but not the other? Welche Art von Fragen können Sie mit der einen, aber nicht mit der anderen beantworten?

Setup. Einrichtung.

Now that you understand why we need these tools and what they do, let's get them installed for our in class demonstrations. Jetzt, da Sie verstehen, warum wir diese Werkzeuge brauchen und was sie tun, lassen Sie uns sie für unsere Unterrichtsvorführungen installieren.

Please complete the following setup tasks in your Windows virtual machine. Bitte vervollständigen Sie die folgenden Einrichtungsaufgaben in Ihrer Windows-Virtual-Machine.

Task One, Install Sysmon for Enhanced Logging. Aufgabe eins, installieren Sie Sysmon für erweiterte Protokollierung.

Download the Sysinternals Suite. Go to the official Microsoft page and download the suite. Laden Sie die Sysinternals-Suite herunter. Gehen Sie zur offiziellen Microsoft-Seite und laden Sie die Suite herunter.

Extract the Files. Extract the downloaded zip file into a folder you can easily access, for example, C colon backslash Tools backslash Sysinternals Suite. Extrahieren Sie die Dateien. Extrahieren Sie die heruntergeladene Zip-Datei in einen Ordner, auf den Sie leicht zugreifen können, zum Beispiel C Doppelpunkt Backslash Tools Backslash Sysinternals Suite.

Download a Configuration File. Sysmon is most powerful when used with a good configuration file that filters out noise. Laden Sie eine Konfigurationsdatei herunter. Sysmon ist am mächtigsten, wenn es mit einer guten Konfigurationsdatei verwendet wird, die Rauschen herausfiltert.

We will use a popular one from Swift On Security. Wir werden eine beliebte von Swift On Security verwenden.

Go to this URL, right click on the page and Save As. Save the file as sysmon dash config dot xml in the same folder where you extracted Sysmon. Gehen Sie zu dieser URL, klicken Sie mit der rechten Maustaste auf die Seite und Speichern unter. Speichern Sie die Datei als sysmon-Strich-config Punkt xml im selben Ordner, wo Sie Sysmon extrahiert haben.

Install Sysmon. Open PowerShell as an Administrator. Installieren Sie Sysmon. Öffnen Sie PowerShell als Administrator.

Navigate to the directory where you extracted Sysmon. For example, cd C colon backslash Tools backslash Sysinternals Suite. Navigieren Sie zum Verzeichnis, wo Sie Sysmon extrahiert haben. Zum Beispiel, cd C Doppelpunkt Backslash Tools Backslash Sysinternals Suite.

Run the following command to install Sysmon with the configuration file. You will be asked to agree to the license terms. Führen Sie den folgenden Befehl aus, um Sysmon mit der Konfigurationsdatei zu installieren. Sie werden gebeten, den Lizenzbedingungen zuzustimmen.

dot backslash Sysmon dot exe dash accepteula dash i dot backslash sysmon dash config dot xml. Punkt Backslash Sysmon Punkt exe Strich accepteula Strich i Punkt Backslash sysmon Strich config Punkt xml.

Verify Installation. Open the Windows Event Viewer. Überprüfen Sie die Installation. Öffnen Sie den Windows Event Viewer.

In the left pane, navigate to Applications and Services Logs, Microsoft, Windows, Sysmon, Operational. Im linken Bereich navigieren Sie zu Applications and Services Logs, Microsoft, Windows, Sysmon, Operational.

You should see a stream of events being logged. Sie sollten einen Strom von Ereignissen sehen, die protokolliert werden.

Task Two, Install the Wazuh Agent. Aufgabe zwei, installieren Sie den Wazuh Agent.

Download the Agent. Go to the Wazuh documentation page for Windows agents and download the latest agent installer, dot msi. Laden Sie den Agent herunter. Gehen Sie zur Wazuh-Dokumentationsseite für Windows-Agents und laden Sie das neueste Agent-Installationsprogramm herunter, Punkt msi.

Install the Agent. Open PowerShell as an Administrator. Installieren Sie den Agent. Öffnen Sie PowerShell als Administrator.

Navigate to the folder where you downloaded the dot msi file. Navigieren Sie zum Ordner, wo Sie die Punkt-msi-Datei heruntergeladen haben.

Run the following installation command. We will use a placeholder IP for the manager. Führen Sie den folgenden Installationsbefehl aus. Wir werden eine Platzhalter-IP für den Manager verwenden.

dot backslash wazuh dash agent dash four dot x dot x dash one dot msi slash q WAZUH underscore MANAGER equals single quote ten dot zero dot zero dot one hundred single quote. Punkt Backslash wazuh Strich agent Strich vier Punkt x Punkt x Strich eins Punkt msi Schrägstrich q WAZUH Unterstrich MANAGER equals einfaches Anführungszeichen zehn Punkt null Punkt null Punkt einhundert einfaches Anführungszeichen.

Note, replace wazuh dash agent dash four dot x dot x dash one dot msi with the exact filename you downloaded. Hinweis, ersetzen Sie wazuh Strich agent Strich vier Punkt x Punkt x Strich eins Punkt msi mit dem genauen Dateinamen, den Sie heruntergeladen haben.

The agent will install in the background. It won't be able to connect, but the service will be installed and running, which is all we need. Der Agent wird im Hintergrund installiert. Er wird sich nicht verbinden können, aber der Dienst wird installiert sein und laufen, was alles ist, was wir brauchen.

Task Three, Install osquery for Live Investigation. Aufgabe drei, installieren Sie osquery für Live-Untersuchung.

Download osquery. Go to the osquery download page and download the Windows dot msi installer. Laden Sie osquery herunter. Gehen Sie zur osquery-Download-Seite und laden Sie das Windows-Punkt-msi-Installationsprogramm herunter.

Install osquery. Double click the dot msi file and follow the steps in the installation wizard. The default options are fine. Installieren Sie osquery. Doppelklicken Sie auf die Punkt-msi-Datei und folgen Sie den Schritten im Installationsassistenten. Die Standardoptionen sind in Ordnung.

Verify Installation. Open PowerShell, as a regular user is fine. Überprüfen Sie die Installation. Öffnen Sie PowerShell, als normaler Benutzer ist in Ordnung.

Navigate to Osquery installation directory, cd single quote C colon backslash Program Files backslash osquery backslash single quote. Navigieren Sie zum Osquery-Installationsverzeichnis, cd einfaches Anführungszeichen C Doppelpunkt Backslash Program Files Backslash osquery Backslash einfaches Anführungszeichen.

Type osqueryi and press Enter. Tippen Sie osqueryi und drücken Sie Enter.

This will launch the osquery interactive shell, osquery greater than. Dies startet die osquery-interaktive Shell, osquery Größer-als.

Run a test query, SELECT name comma version comma install underscore date FROM programs LIMIT five semicolon. Führen Sie eine Testabfrage aus, SELECT name Komma version Komma install Unterstrich date FROM programs LIMIT fünf Semikolon.

This should show you five programs installed on your system. Type dot exit to quit. Dies sollte Ihnen fünf Programme zeigen, die auf Ihrem System installiert sind. Tippen Sie Punkt exit, um zu beenden.

Try it yourself. Probieren Sie es selbst aus.

After installing Sysmon, open a new PowerShell window and run the command ipconfig slash all. Nach der Installation von Sysmon öffnen Sie ein neues PowerShell-Fenster und führen Sie den Befehl ipconfig Schrägstrich all aus.

Now, go back to the Sysmon event log in Event Viewer. Gehen Sie jetzt zurück zum Sysmon-Event-Log im Event Viewer.

Can you find the Process Create event, Event ID one, for ipconfig dot exe? Können Sie das Prozesserstellungsereignis, Event ID eins, für ipconfig Punkt exe finden?

Look at the details. What was the full Command Line that was recorded? Schauen Sie sich die Details an. Was war die vollständige Befehlszeile, die aufgezeichnet wurde?

This is the kind of detail that is critical during an investigation. Dies ist die Art von Detail, die während einer Untersuchung kritisch ist.